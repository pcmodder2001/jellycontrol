{% extends 'base.html' %}

{% block title %}Settings{% endblock %}

{% block content %}
<div class="uk-container uk-margin-large-top">
    <!-- Main Heading -->
    <h1 class="uk-heading-line uk-text-center" style="width: 100%; padding-bottom: 20px;">
        <span>Application Settings</span>
    </h1>   

    <!-- Settings Form -->
    <div class="uk-grid uk-grid-large uk-child-width-1-2@s uk-flex-center" uk-grid>
        <!-- Config Form -->
        <div>
            <form method="post" action="{% url 'settings' %}" class="uk-form-stacked uk-box-shadow-small uk-padding uk-background-muted" style="border-radius: 10px;">
                {% csrf_token %}
                
                <div class="uk-margin">
                    <label class="uk-form-label" for="server_url">Server URL:</label>
                    <div class="uk-form-controls">
                        <input 
                            class="uk-input uk-form-large" 
                            id="server_url" 
                            name="server_url" 
                            type="text" 
                            value="{{ config.server_url }}" 
                            placeholder="https://example.com/" 
                            required
                        >
                        <p class="uk-text-small uk-text-danger uk-margin-small-top">
                            <strong>Note:</strong> Ensure the URL ends with a <code>/</code> for images to load correctly.
                        </p>
                    </div>
                </div>
                


                <div class="uk-margin">
                    <label class="uk-form-label" for="jellyfin_api_key">Jellyfin API Key:</label>
                    <div class="uk-form-controls uk-flex">
                        <input 
                            class="uk-input uk-form-large" 
                            id="jellyfin_api_key" 
                            name="jellyfin_api_key" 
                            type="text" 
                            style="width: 70%;" 
                            value="{{ config.jellyfin_api_key }}" 
                            placeholder="Enter API Key" 
                        >
                        <button 
                            type="button" 
                            id="generate-api-key-btn" 
                            class="uk-button uk-button-primary uk-margin-left"
                        >
                            Generate
                        </button>
                    </div>
                    <p class="uk-text-meta uk-margin-small-top" id="api-key-status"></p>
                </div>

                <div class="uk-margin">
                    <label class="uk-form-label" for="invite_code">Jellyfin Invite Code:</label>
                    <div class="uk-form-controls">
                        <input 
                            class="uk-input uk-form-large" 
                            id="invite_code" 
                            name="invite_code" 
                            type="text" 
                            value="{{ config.invite_code }}" 
                            placeholder="Enter Invite Code" 
                        >
                    </div>
                </div>

                <button 
                    class="uk-button uk-button-primary uk-width-1-1 uk-margin-top" 
                    type="submit"
                >
                    Save Configuration
                </button>
            </form>
        </div>
    </div>
</div>

<!-- JavaScript for handling the API key generation request -->
<script>
document.getElementById('generate-api-key-btn').addEventListener('click', function() {
    const csrfToken = '{{ csrf_token }}';
    const apiKeyStatus = document.getElementById('api-key-status');
    apiKeyStatus.textContent = 'Generating API key...';

    fetch("{% url 'generate_api_key' %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('jellyfin_api_key').value = data.message;
            apiKeyStatus.textContent = 'API key generated successfully!';
            apiKeyStatus.className = 'uk-text-success';
        } else {
            apiKeyStatus.textContent = `Error: ${data.error}`;
            apiKeyStatus.className = 'uk-text-danger';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        apiKeyStatus.textContent = 'An error occurred while generating the API key.';
        apiKeyStatus.className = 'uk-text-danger';
    });
});
</script>
{% endblock %}
